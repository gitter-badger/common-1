var NAILS_Admin_CMS_pages_Create_Edit;NAILS_Admin_CMS_pages_Create_Edit=function(){this.editor_id=Math.floor(Math.random()*1e16);this.search_placeholder="Search widget library";this.widgets=[];this._dragging_widget=!1;this.init=function(e){this.widgets=e;this._template_chooser_init();this._editor_init()};this._template_chooser_init=function(){$("label.template").on("click",function(){$("label.template").removeClass("selected");$(this).addClass("selected");var e=$(this).data("template-slug");$("a.launch-editor").hide();$("a.launch-editor.template-"+e).show()})};this._editor_init=function(){var e=this,t=$("<div>").attr("id",this.editor_id).addClass("group-cms pages widgeteditor ready"),n=$("<div>").attr("id",this.editor_id+"-loader").addClass("loader").html('<span class="ion-looping"></span>'),r=$("<ul>").attr("id",this.editor_id+"-header").addClass("header").html($("#template-header").html()),i=$("<ul>").attr("id",this.editor_id+"-widgets").addClass("widgets").disableSelection(),s=$("<li>").attr("id",this.editor_id+"-search").addClass("search").html($("#template-widget-search").html()),o=$("<ul>").attr("id",this.editor_id+"-dropzone").addClass("dropzone empty").html($("#template-dropzone-empty").html());i.append(s);var u,a,f,l,c;u=0;a=$("#template-widget-grouping").html();f=$("#template-widget").html();for(var h in this.widgets){l={name:this.widgets[h].label,group:"group-"+u};c=Mustache.render(a,l);i.append(c);for(var p in this.widgets[h].widgets){l={group:"group-"+u,name:this.widgets[h].widgets[p].label,description:this.widgets[h].widgets[p].description,keywords:this.widgets[h].widgets[p].keywords,slug:this.widgets[h].widgets[p].slug};c=Mustache.render(f,l);i.append(c)}u++}t.append(n);t.append(r);t.append(o);t.append(i);$("body").append(t);$("a.launch-editor").on("click",function(){var t=$(this).data("template"),n=$(this).data("area");e._editor_launch(t,n);return!1})};this._editor_launch=function(e,t){$("#"+this.editor_id).removeClass("ready").show();$("body").addClass("noscroll");this._load_widgets_for_area(e,t);this._editor_construct(e,t);$("#"+this.editor_id).addClass("ready")};this._editor_construct=function(e,t){var n=this,r=$("#template-dropzone-widget").html();$("#"+this.editor_id+"-dropzone").sortable({placeholder:"placeholder",handle:".sorter",start:function(e,t){t.placeholder.height(t.helper.height())},stop:function(e,t){var i,s,o,u,a;i=$(t.item).data("slug");s=n._get_widget(i);o={id:"widget-editor-"+Math.floor(Math.random()*1e16),slug:i,label:s.label,description:s.description};u=Mustache.render(r,o);a=$("<li>");a.addClass("dropzone-widget "+o.slug);a.attr("id",o.id);a.data("slug",o.slug);a.html(u);t.item.replaceWith(a);$("#"+n.editor_id+"-dropzone").removeClass("empty");$("#"+n.editor_id+"-dropzone li.empty").remove()},over:function(){$("#"+n.editor_id+"-dropzone").removeClass("empty");$("#"+n.editor_id+"-dropzone li.empty").remove()},out:function(){var e=0;e+=$("#"+n.editor_id+"-dropzone li.dropzone-widget").length;e+=$("#"+n.editor_id+"-dropzone li.widget").length;if(e<=1){var t=$("#template-dropzone-empty").html();$("#"+n.editor_id+"-dropzone").addClass("empty").append(t)}}});for(var i in this.widgets)for(var s in this.widgets[i].widgets){this.widgets[i].widgets[s].restrict_to_template.length&&this._array_search(e,this.widgets[i].widgets[s].restrict_to_template)===!1&&$("#"+this.editor_id+"-widgets li.widget."+this.widgets[i].widgets[s].slug).addClass("disabled");this.widgets[i].widgets[s].restrict_to_area.length&&this._array_search(t,this.widgets[i].widgets[s].restrict_to_area)===!1&&$("#"+this.editor_id+"-widgets li.widget."+this.widgets[i].widgets[s].slug).addClass("disabled");if(this.widgets[i].widgets[s].restrict_from_template.length&&this._array_search(e,this.widgets[i].widgets[s].restrict_from_template)!==!1){console.log(this.widgets[i].widgets[s],e,this._array_search(e,this.widgets[i].widgets[s].restrict_from_template));$("#"+this.editor_id+"-widgets li.widget."+this.widgets[i].widgets[s].slug).addClass("disabled")}this.widgets[i].widgets[s].restrict_from_area.length&&this._array_search(t,this.widgets[i].widgets[s].restrict_from_area)!==!1&&$("#"+this.editor_id+"-widgets li.widget."+this.widgets[i].widgets[s].slug).addClass("disabled")}$("#"+this.editor_id+"-widgets li.widget:not(.disabled)").draggable({helper:function(e){var t=$(e.currentTarget);return $("<div>").addClass("dragging-widget").text(t.data("title"))},appendTo:"#"+this.editor_id,zIndex:3,connectToSortable:"#"+this.editor_id+"-dropzone",start:function(){n._dragging_widget=!0},stop:function(){n._dragging_widget=!1}});$(document).on("keyup",function(e){!n._dragging_widget&&e.keyCode===27&&n._editor_close()});$("#"+this.editor_id+"-search a.minimiser").on("click",function(){$("#"+n.editor_id).toggleClass("minimised")});$("#"+this.editor_id+"-search input").on("keyup",function(){var e=$.trim($(this).val());e.length>0?$("#"+n.editor_id+"-widgets li.widget").each(function(){var t=$(this).data("keywords").split(","),n=new RegExp(e,"gi");if(n.test(t)){$(this).addClass("search-hit");$(this).removeClass("search-miss")}else{$(this).addClass("search-miss");$(this).removeClass("search-hit")}}):$("#"+n.editor_id+"-widgets li.widget").removeClass("search-miss search-hit")});$("#"+this.editor_id+"-widgets li.grouping").on("click",function(){$(this).toggleClass("open");var e=$(this).data("group");$("#"+n.editor_id+"-widgets li.widget."+e).toggleClass("hidden")});$("#"+this.editor_id+"-header ul.rhs a").on("click",function(){var e=$(this).data("action");switch(e){case"close":n._editor_close()}return!1})};this._editor_destruct=function(){console.log("TODO");$("body").removeClass("noscroll");$("#"+this.editor_id+"-widgets li.widget:not(.disabled)").draggable("destroy");$("#"+this.editor_id+"-widgets li.dropzone").sortable("destroy");$("#"+this.editor_id+"-widgets li.widget.disabled").removeClass("disabled");$(document).off("keyup");$("#"+this.editor_id+"-search a.minimiser").off("click");$("#"+this.editor_id+"-search input").off("keyup");$("#"+this.editor_id+"-widgets li.grouping").off("click");$("#"+this.editor_id+"-header ul.rhs a").off("click")};this._load_widgets_for_area=function(e,t){var n=$("#template-dropzone-empty").html();$("#"+this.editor_id+"-dropzone").addClass("empty").html(n);console.log("TODO",e,t)};this._editor_close=function(){$("#"+this.editor_id).hide();this._editor_destruct()};this._get_widget=function(e){for(var t in this.widgets)for(var n in this.widgets[t].widgets)if(e===this.widgets[t].widgets[n].slug)return this.widgets[t].widgets[n];return!1};this._array_search=function(e,t,n){var r=!!n,i="";if(t&&typeof t=="object"&&t.change_key_case)return t.search(e,n);if(typeof e=="object"&&e.exec){if(!r){var s="i"+(e.global?"g":"")+(e.multiline?"m":"")+(e.sticky?"y":"");e=new RegExp(e.source,s)}for(i in t)if(e.test(t[i]))return i;return!1}for(i in t)if(r&&t[i]===e||!r&&t[i]==e)return i;return!1}};