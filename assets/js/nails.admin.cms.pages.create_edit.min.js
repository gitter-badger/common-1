var NAILS_Admin_CMS_pages_Create_Edit;NAILS_Admin_CMS_pages_Create_Edit=function(){this.editor_id=Math.floor(Math.random()*1e16);this._editor={};this.search_placeholder="Search widget library";this.templates=[];this.mustache_tpl={};this.widgets=[];this.page_data={};this._dragging_widget=!1;this._editor_open=!1;this._saving=!1;this._refreshing=!1;this._autosave=null;this._autosave_delay=5e3;this.init=function(e,t,n){this.templates=e;this.widgets=t;var r,i;if(typeof n=="undefined"||n===null){this.page_data={hash:"NOHASH",data:{id:null},widget_areas:{}};for(r in this.templates){this.page_data.widget_areas[r]={};for(i in this.templates[r].widget_areas)this.page_data.widget_areas[r][i]=[]}this._refresh_page_data()}else{typeof this.page_data.id=="undefined"&&(this.page_data.id=null);for(r in this.templates){typeof this.page_data[r]=="undefined"&&(this.page_data[r]={});for(i in this.templates[r].widget_areas)typeof this.page_data[r][i]=="undefined"&&(this.page_data[r][i]=[])}}this.page_data.hash=this._generate_data_hash();console.log("Initial page_data:",this.page_data);this._template_chooser_init();this._editor_init();var s=this;window.onbeforeunload=function(){s._needs_saved()!==!1&&s._save()};$("#action-save").on("click",function(){var e=$(this);if(e.hasClass("disabled")){console.log("Button disabled, ignoring second request");return!1}var t=function(t){e.text("Saved!");window.location.href=window.SITE_URL+"admin/cms/pages/edit/"+t.id+"?message=saved"},n=function(t){var n=e.data("oldtext");e.text(n);s._enable_main_actions();$("<div>").text(t.error).dialog({title:"Something went wrong.",resizable:!1,draggable:!1,modal:!0,buttons:{OK:function(){$(this).dialog("close")}}})},r=e.text();e.data("oldtext",r);e.html('<span class="ion-looping"></span> Saving...');s._disable_main_actions();s._save(!1,t,n,!0);return!1});$("#action-publish").on("click",function(){var e=$(this);if(e.hasClass("disabled")){console.log("Button disabled, ignoring second request");return!1}var t=function(t){e.text("Published!");window.location.href=window.SITE_URL+"admin/cms/pages/edit/"+t.id+"?message=published"},n=function(t){var n=e.data("oldtext");e.text(n);s._enable_main_actions();$("<div>").text(t.error).dialog({title:"Something went wrong.",resizable:!1,draggable:!1,modal:!0,buttons:{OK:function(){$(this).dialog("close")}}})},r=e.text();e.data("oldtext",r);e.html('<span class="ion-looping"></span> Publishing...');s._disable_main_actions();s._save(!1,t,n,!0,!0);return!1});$("a.launch-preview").on("click",function(){s._launch_preview();return!1});this._autosave_start()};this._disable_main_actions=function(){$("a.main-action").addClass("disabled")};this._enable_main_actions=function(){$("a.main-action").removeClass("disabled")};this._autosave_start=function(){var e=this;this._autosave=setInterval(function(){e._save(!0)},this._autosave_delay)};this._autosave_stop=function(){clearInterval(this._autosave)};this._save=function(e,t,n,r,i){if(this._saving){console.log("Save in progress, ignoring repeated call.");return!1}if(this._refreshing){console.log("Refresh in progress, ignoring repeated call.");return!1}var s=this._needs_saved();if(s!==!1||r){if(r!==!0){console.log("Data has changed, old hash: "+this.page_data.hash+", new hash: "+s+" - Saving...");this.page_data.hash=s}else console.log("Forced save requested. Saving...");this._saving=!0;$("#save-status").removeClass("message").addClass("saving notice").show();$("#save-status .last-saved").text("Saving...");var o=this;$.ajax({type:"POST",url:window.SITE_URL+"api/cms/pages/save",data:{page_data:JSON.stringify(this.page_data),do_publish:i},success:function(n){if(n.status===200){o.page_data.data.id=n.id;o.page_data.hash=o._generate_data_hash();$("#save-status").removeClass("saving");var r=new Date,i=r.getHours()<10?"0"+r.getHours():r.getHours(),s=r.getMinutes()<10?"0"+r.getMinutes():r.getMinutes(),u=i+":"+s;e&&(u+=" (Autosave)");$("#save-status .last-saved").text(u);console.log("Save completed successfully")}else{$("#save-status").removeClass("saving notice").addClass("message");$("#save-status .last-saved").text("ERROR: "+n.error);console.log("Save failed: "+n.error)}o._saving=!1;typeof t=="function"&&t.call(undefined,n)},error:function(e){var t=JSON.parse(e.responseText);$("#save-status").removeClass("saving notice").addClass("message");$("#save-status .last-saved").text("ERROR: "+t.error);console.log("Save failed: "+t.error);o._saving=!1;typeof n=="function"&&n.call(undefined,e)}});return!0}console.log("Page data hasn't changed, ignoring call");return!1};this._needs_saved=function(){this._refresh_page_data();var e=this._generate_data_hash();return this.page_data.hash!==e?e:!1};this._refresh_page_data=function(){this._refreshing=!0;this.page_data.data.title=$("input[name=title]").val();this.page_data.data.is_published=$("input[name=is_published]").val();this.page_data.data.parent_id=$("select[name=parent_id]").val();this.page_data.data.seo_description=$("input[name=seo_description]").val();this.page_data.data.seo_keywords=$("input[name=seo_keywords]").val();this.page_data.data.template=$("input[name=template]").val();if(this._editor_open){var e=this,t=this._editor.dropzone.data("template"),n=this._editor.dropzone.data("area");typeof this.page_data.widget_areas[t]=="undefined"&&(this.page_data.widget_areas[t]={});this.page_data.widget_areas[t][n]=[];this._editor.dropzone.find("li.processed.dropzone-widget").each(function(){var r={widget:$(this).data("slug"),data:$(this).find("form.editor").serializeArray()};e.page_data.widget_areas[t][n].push(r)})}this._refreshing=!1};this._generate_data_hash=function(){var e=$.extend({},this.page_data);e.hash="";var t=JSON.stringify(e),n=this.md5(t);return n};this._template_chooser_init=function(){$("label.template").on("click",function(){$("label.template").removeClass("selected");$(this).addClass("selected");var e=$(this).data("template-slug");$("a.launch-editor").hide();$("a.launch-editor.template-"+e).show()})};this._editor_init=function(){var e=this;this.mustache_tpl.loader=$("#template-loader").html();this.mustache_tpl.widget_search=$("#template-widget-search").html();this.mustache_tpl.dropzone_empty=$("#template-dropzone-empty").html();this.mustache_tpl.widget_grouping=$("#template-widget-grouping").html();this.mustache_tpl.widget=$("#template-widget").html();this.mustache_tpl.header=$("#template-header").html();this.mustache_tpl.dropzone_empty=$("#template-dropzone-empty").html();this.mustache_tpl.dropzone_widget=$("#template-dropzone-widget").html();this._editor.container=$("<div>").attr("id",this.editor_id).addClass("group-cms pages widgeteditor ready");this._editor.loader=$("<div>").attr("id",this.editor_id+"-loader").addClass("loader").html(this.mustache_tpl.loader);this._editor.header=$("<ul>").attr("id",this.editor_id+"-header").addClass("header");this._editor.widgets=$("<ul>").attr("id",this.editor_id+"-widgets").addClass("widgets").disableSelection();this._editor.widgets_search=$("<li>").attr("id",this.editor_id+"-search").addClass("search").html(this.mustache_tpl.widget_search);this._editor.dropzone=$("<ul>").attr("id",this.editor_id+"-dropzone").addClass("dropzone empty").html(this.mustache_tpl.dropzone_empty);this._editor.widgets.append(this._editor.widgets_search);var t,n,r,i,s,o,u;t=0;n=this.mustache_tpl.widget_grouping;r=this.mustache_tpl.widget;for(var a in this.widgets){i={name:this.widgets[a].label,group:"group-"+t};s=Mustache.render(n,i);this._editor.widgets.append(s);for(var f in this.widgets[a].widgets){i={group:"group-"+t,name:this.widgets[a].widgets[f].label,description:this.widgets[a].widgets[f].description,keywords:this.widgets[a].widgets[f].keywords,slug:this.widgets[a].widgets[f].slug};s=Mustache.render(r,i);this._editor.widgets.append(s);o="var _WIDGET_CALLBACKS_"+this.widgets[a].widgets[f].slug+" = function(){";o+="this.dropped = function( ui ){";this.widgets[a].widgets[f].callbacks.dropped.length>0&&(o+=this.widgets[a].widgets[f].callbacks.dropped);o+="};";o+="this.sort_start = function( ui ){";this.widgets[a].widgets[f].callbacks.sort_start.length>0&&(o+=this.widgets[a].widgets[f].callbacks.sort_start);o+="};";o+="this.sort_stop = function( ui ){";this.widgets[a].widgets[f].callbacks.sort_stop.length>0&&(o+=this.widgets[a].widgets[f].callbacks.sort_stop);o+="};";o+="this.remove_start = function( ui ){";this.widgets[a].widgets[f].callbacks.remove_start.length>0&&(o+=this.widgets[a].widgets[f].callbacks.remove_start);o+="};";o+="this.remove_stop = function( ui ){";this.widgets[a].widgets[f].callbacks.remove_stop.length>0&&(o+=this.widgets[a].widgets[f].callbacks.remove_stop);o+="};";o+="};";o+="var _WIDGET_"+this.widgets[a].widgets[f].slug+" = new _WIDGET_CALLBACKS_"+this.widgets[a].widgets[f].slug+"();";u=$("<script>").attr("id","callbacks-"+this.widgets[a].widgets[f].slug).attr("type","text/javascript").html(o);$("body").append(u)}t++}this._editor.container.append(this._editor.loader);this._editor.container.append(this._editor.header);this._editor.container.append(this._editor.dropzone);this._editor.container.append(this._editor.widgets);$("body").append(this._editor.container);$("a.launch-editor").on("click",function(){var t=$(this).data("template"),n=$(this).data("area");e._editor_launch(t,n);return!1})};this._editor_launch=function(e,t){$("#"+this.editor_id).removeClass("ready").show();$("body").addClass("noscroll");this._load_widgets_for_area(e,t);this._editor_construct(e,t);$("#"+this.editor_id).addClass("ready")};this._editor_construct=function(e,t){var n=this;this._editor.dropzone.data("template",e);this._editor.dropzone.data("area",t);var r,i;r=this._get_template(e);r.active_area=r.widget_areas[t].title;i=this.mustache_tpl.header;i=Mustache.render(i,r);this._editor.header.html(i);this._editor.dropzone.sortable({placeholder:"placeholder",handle:".sorter",start:function(e,t){t.placeholder.height(t.helper.height());if(t.item.hasClass("processed")){var n=t.item.data("slug");window["_WIDGET_"+n].sort_start(t.item)}},update:function(e,t){t.item.hasClass("processed")||n._drop_widget(r.slug,t.item)},over:function(){n._editor.dropzone.removeClass("empty");n._editor.dropzone.find("li.empty").remove()},out:function(){var e=0;e+=n._editor.dropzone.find("li.dropzone-widget").length;e+=n._editor.dropzone.find("li.widget").length;if(e<=1){var t=n.mustache_tpl.dropzone_empty;n._editor.dropzone.addClass("empty").append(t)}},stop:function(e,t){if(n._editor.dropzone.find("li.dropzone-widget").length<=0){var r=n.mustache_tpl.dropzone_empty;n._editor.dropzone.addClass("empty").append(r)}else{n._editor.dropzone.removeClass("empty");n._editor.dropzone.find("li.empty").remove()}if(t.item.hasClass("processed")){var i=t.item.data("slug");window["_WIDGET_"+i].sort_stop(t.item)}}});for(var s in this.widgets)for(var o in this.widgets[s].widgets){this.widgets[s].widgets[o].restrict_to_template.length&&this._array_search(e,this.widgets[s].widgets[o].restrict_to_template)===!1&&this._editor.widgets.find("li.widget."+this.widgets[s].widgets[o].slug).addClass("disabled");this.widgets[s].widgets[o].restrict_to_area.length&&this._array_search(t,this.widgets[s].widgets[o].restrict_to_area)===!1&&this._editor.widgets.find("li.widget."+this.widgets[s].widgets[o].slug).addClass("disabled");this.widgets[s].widgets[o].restrict_from_template.length&&this._array_search(e,this.widgets[s].widgets[o].restrict_from_template)!==!1&&this._editor.widgets.find("li.widget."+this.widgets[s].widgets[o].slug).addClass("disabled");this.widgets[s].widgets[o].restrict_from_area.length&&this._array_search(t,this.widgets[s].widgets[o].restrict_from_area)!==!1&&this._editor.widgets.find("li.widget."+this.widgets[s].widgets[o].slug).addClass("disabled")}this._editor.widgets.find("li.widget:not(.disabled)").draggable({helper:function(e){var t=$(e.currentTarget);return $("<div>").addClass("dragging-widget").text(t.data("title"))},appendTo:"#"+this.editor_id,zIndex:3,connectToSortable:this._editor.dropzone,start:function(){n._dragging_widget=!0},stop:function(){n._dragging_widget=!1}});$(document).on("keyup",function(e){!n._dragging_widget&&e.keyCode===27&&n._editor_close()});this._editor.widgets_search.find("a.minimiser").on("click",function(){$("#"+n.editor_id).toggleClass("minimised")});this._editor.widgets_search.find("input").on("keyup",function(){var e=$.trim($(this).val());e.length>0?n._editor.widgets.find("li.widget").each(function(){var t=$(this).data("keywords").split(","),n=new RegExp(e,"gi");if(n.test(t)){$(this).addClass("search-hit");$(this).removeClass("search-miss")}else{$(this).addClass("search-miss");$(this).removeClass("search-hit")}}):n._editor.widgets.find("li.widget").removeClass("search-miss search-hit")});this._editor.widgets.find("li.grouping").on("click",function(){$(this).toggleClass("open");var e=$(this).data("group");n._editor.widgets.find("li.widget."+e).toggleClass("hidden")});n._editor.header.find("ul.rhs a").on("click",function(){var e=$(this).data("action");switch(e){case"close":n._editor_close();break;case"preview":n._launch_preview()}return!1});this._editor_open=!0};this._editor_destruct=function(){this._save();$("body").removeClass("noscroll");this._editor.widgets.find("li.widget:not(.disabled)").draggable("destroy");this._editor.widgets.find("li.dropzone").sortable("destroy");this._editor.widgets.find("li.widget.disabled").removeClass("disabled");$(document).off("keyup");this._editor.widgets_search.find("a.minimiser").off("click");this._editor.widgets_search.find("input").off("keyup");this._editor.widgets.find("li.grouping").off("click");this._editor.header.find("ul.rhs a").off("click");this._editor.dropzone.data("template","");this._editor.dropzone.data("area","");this._editor_open=!1};this._load_widgets_for_area=function(e,t){var n=this.mustache_tpl.dropzone_empty;this._editor.dropzone.addClass("empty").html(n);if(typeof this.page_data.widget_areas[e][t]!="undefined"&&this.page_data.widget_areas[e][t].length){this._editor.dropzone.removeClass("empty");this._editor.dropzone.find("li.empty").remove();for(var r in this.page_data.widget_areas[e][t]){var i=this.page_data.widget_areas[e][t][r],s=$("<div>").data("slug",i.widget);this._editor.dropzone.append(s);this._drop_widget(e,s,i.data)}}};this._drop_widget=function(e,t,n){var r,i,s,o,u;r=$(t).data("slug");i=this._get_widget(r);s={id:"widget-editor-"+Math.floor(Math.random()*1e16),slug:r,label:i.label,description:i.description};o=Mustache.render(this.mustache_tpl.dropzone_widget,s);u=$("<li>");u.addClass("processed dropzone-widget "+s.slug);u.attr("id",s.id);u.data("slug",s.slug);u.html(o);var a=this;$(".header-bar .closer",u).on("click",function(e){var t=$(this).closest("li.dropzone-widget").attr("id");a._remove_widget(t);e.stopPropagation();return!1});t.replaceWith(u);this._editor.dropzone.removeClass("empty");this._editor.dropzone.find("li.empty").remove();var f={controller:"cms/pages",method:"widget/get_editor",data:{widget:i.slug,template:e,id:s.id,data:JSON.stringify(n)},success:function(e){$(u).find(".editor").html(e.HTML);window["_WIDGET_"+i.slug].dropped(u);var t=u.find(".header-bar").outerHeight(),n=u.find(".editor").outerHeight(),r=t+n;u.animate({height:r},250);a._refresh_page_data()},error:function(e){var t=JSON.parse(e.responseText);$(u).addClass("error").find(".editor").html('<p class="system-alert error no-close"><strong>Error:</strong> '+t.error+"</p>")}};window.NAILS.API.call(f)};this._remove_widget=function(e){var t=this;$("<div>").text("Are you sure you wish to remove this widget from the interface?").dialog({title:"Are you sure?",resizable:!1,draggable:!1,modal:!0,buttons:{OK:function(){var n=$("#"+e),r=n.data("slug");window["_WIDGET_"+r].remove_start(n);$(this).dialog("close");n.animate({opacity:0,height:0},250,function(){n.remove();if(t._editor.dropzone.find("li.dropzone-widget").length<=0){var e=t.mustache_tpl.dropzone_empty;t._editor.dropzone.addClass("empty").append(e).find("li.empty").css({opacity:0}).animate({opacity:1},250)}window["_WIDGET_"+r].remove_stop(n)})},Cancel:function(){$(this).dialog("close")}}});$(".ui-widget-overlay").css({zIndex:1e3})};this._editor_close=function(){$("#"+this.editor_id).hide();this._editor_destruct()};this._launch_preview=function(){var e=$('<div class="fancybox-overlay" style="width:100%;height:100%;display:block;"></div>').appendTo("body"),t=$('<div id="fancybox-loading"><div></div></div>').appendTo("body"),n=function(n){e.remove();t.remove();$.fancybox({type:"iframe",href:window.SITE_URL+"cms/render/preview/"+n.id,width:"90%",height:"90%"})},r=function(n){e.remove();t.remove();$("<div>").text(n.error).dialog({title:"Something went wrong.",resizable:!1,draggable:!1,modal:!0,buttons:{OK:function(){$(this).dialog("close")}}})};this._save(!1,n,r,!0)};this._get_template=function(e){for(var t in this.templates)if(e===this.templates[t].slug)return this.templates[t];return!1};this._get_widget=function(e){for(var t in this.widgets)for(var n in this.widgets[t].widgets)if(e===this.widgets[t].widgets[n].slug)return this.widgets[t].widgets[n];return!1};this._array_search=function(e,t,n){var r=!!n,i="";if(t&&typeof t=="object"&&t.change_key_case)return t.search(e,n);if(typeof e=="object"&&e.exec){if(!r){var s="i"+(e.global?"g":"")+(e.multiline?"m":"")+(e.sticky?"y":"");e=new RegExp(e.source,s)}for(i in t)if(e.test(t[i]))return i;return!1}for(i in t)if(r&&t[i]===e||!r&&t[i]==e)return i;return!1};this.md5=function(e){var t,n=function(e,t){return e<<t|e>>>32-t},r=function(e,t){var n,r,i,s,o;i=e&2147483648;s=t&2147483648;n=e&1073741824;r=t&1073741824;o=(e&1073741823)+(t&1073741823);return n&r?o^2147483648^i^s:n|r?o&1073741824?o^3221225472^i^s:o^1073741824^i^s:o^i^s},i=function(e,t,n){return e&t|~e&n},s=function(e,t,n){return e&n|t&~n},o=function(e,t,n){return e^t^n},u=function(e,t,n){return t^(e|~n)},a=function(e,t,s,o,u,a,f){e=r(e,r(r(i(t,s,o),u),f));return r(n(e,a),t)},f=function(e,t,i,o,u,a,f){e=r(e,r(r(s(t,i,o),u),f));return r(n(e,a),t)},l=function(e,t,i,s,u,a,f){e=r(e,r(r(o(t,i,s),u),f));return r(n(e,a),t)},c=function(e,t,i,s,o,a,f){e=r(e,r(r(u(t,i,s),o),f));return r(n(e,a),t)},h=function(e){var t,n=e.length,r=n+8,i=(r-r%64)/64,s=(i+1)*16,o=new Array(s-1),u=0,a=0;while(a<n){t=(a-a%4)/4;u=a%4*8;o[t]=o[t]|e.charCodeAt(a)<<u;a++}t=(a-a%4)/4;u=a%4*8;o[t]=o[t]|128<<u;o[s-2]=n<<3;o[s-1]=n>>>29;return o},p=function(e){var t="",n="",r,i;for(i=0;i<=3;i++){r=e>>>i*8&255;n="0"+r.toString(16);t+=n.substr(n.length-2,2)}return t},d=[],v,m,g,y,b,w,E,S,x,T=7,N=12,C=17,k=22,L=5,A=9,O=14,M=20,_=4,D=11,P=16,H=23,B=6,j=10,F=15,I=21;e=this.utf8_encode(e);d=h(e);w=1732584193;E=4023233417;S=2562383102;x=271733878;t=d.length;for(v=0;v<t;v+=16){m=w;g=E;y=S;b=x;w=a(w,E,S,x,d[v+0],T,3614090360);x=a(x,w,E,S,d[v+1],N,3905402710);S=a(S,x,w,E,d[v+2],C,606105819);E=a(E,S,x,w,d[v+3],k,3250441966);w=a(w,E,S,x,d[v+4],T,4118548399);x=a(x,w,E,S,d[v+5],N,1200080426);S=a(S,x,w,E,d[v+6],C,2821735955);E=a(E,S,x,w,d[v+7],k,4249261313);w=a(w,E,S,x,d[v+8],T,1770035416);x=a(x,w,E,S,d[v+9],N,2336552879);S=a(S,x,w,E,d[v+10],C,4294925233);E=a(E,S,x,w,d[v+11],k,2304563134);w=a(w,E,S,x,d[v+12],T,1804603682);x=a(x,w,E,S,d[v+13],N,4254626195);S=a(S,x,w,E,d[v+14],C,2792965006);E=a(E,S,x,w,d[v+15],k,1236535329);w=f(w,E,S,x,d[v+1],L,4129170786);x=f(x,w,E,S,d[v+6],A,3225465664);S=f(S,x,w,E,d[v+11],O,643717713);E=f(E,S,x,w,d[v+0],M,3921069994);w=f(w,E,S,x,d[v+5],L,3593408605);x=f(x,w,E,S,d[v+10],A,38016083);S=f(S,x,w,E,d[v+15],O,3634488961);E=f(E,S,x,w,d[v+4],M,3889429448);w=f(w,E,S,x,d[v+9],L,568446438);x=f(x,w,E,S,d[v+14],A,3275163606);S=f(S,x,w,E,d[v+3],O,4107603335);E=f(E,S,x,w,d[v+8],M,1163531501);w=f(w,E,S,x,d[v+13],L,2850285829);x=f(x,w,E,S,d[v+2],A,4243563512);S=f(S,x,w,E,d[v+7],O,1735328473);E=f(E,S,x,w,d[v+12],M,2368359562);w=l(w,E,S,x,d[v+5],_,4294588738);x=l(x,w,E,S,d[v+8],D,2272392833);S=l(S,x,w,E,d[v+11],P,1839030562);E=l(E,S,x,w,d[v+14],H,4259657740);w=l(w,E,S,x,d[v+1],_,2763975236);x=l(x,w,E,S,d[v+4],D,1272893353);S=l(S,x,w,E,d[v+7],P,4139469664);E=l(E,S,x,w,d[v+10],H,3200236656);w=l(w,E,S,x,d[v+13],_,681279174);x=l(x,w,E,S,d[v+0],D,3936430074);S=l(S,x,w,E,d[v+3],P,3572445317);E=l(E,S,x,w,d[v+6],H,76029189);w=l(w,E,S,x,d[v+9],_,3654602809);x=l(x,w,E,S,d[v+12],D,3873151461);S=l(S,x,w,E,d[v+15],P,530742520);E=l(E,S,x,w,d[v+2],H,3299628645);w=c(w,E,S,x,d[v+0],B,4096336452);x=c(x,w,E,S,d[v+7],j,1126891415);S=c(S,x,w,E,d[v+14],F,2878612391);E=c(E,S,x,w,d[v+5],I,4237533241);w=c(w,E,S,x,d[v+12],B,1700485571);x=c(x,w,E,S,d[v+3],j,2399980690);S=c(S,x,w,E,d[v+10],F,4293915773);E=c(E,S,x,w,d[v+1],I,2240044497);w=c(w,E,S,x,d[v+8],B,1873313359);x=c(x,w,E,S,d[v+15],j,4264355552);S=c(S,x,w,E,d[v+6],F,2734768916);E=c(E,S,x,w,d[v+13],I,1309151649);w=c(w,E,S,x,d[v+4],B,4149444226);x=c(x,w,E,S,d[v+11],j,3174756917);S=c(S,x,w,E,d[v+2],F,718787259);E=c(E,S,x,w,d[v+9],I,3951481745);w=r(w,m);E=r(E,g);S=r(S,y);x=r(x,b)}var q=p(w)+p(E)+p(S)+p(x);return q.toLowerCase()};this.utf8_encode=function(e){if(e===null||typeof e=="undefined")return"";var t=e+"",n="",r,i,s=0;r=i=0;s=t.length;for(var o=0;o<s;o++){var u=t.charCodeAt(o),a=null;if(u<128)i++;else if(u>127&&u<2048)a=String.fromCharCode(u>>6|192,u&63|128);else if(u&!0)a=String.fromCharCode(u>>12|224,u>>6&63|128,u&63|128);else{if(u&!0)throw new RangeError("Unmatched trail surrogate at "+o);var f=t.charCodeAt(++o);if(f&!0)throw new RangeError("Unmatched lead surrogate at "+(o-1));u=((u&1023)<<10)+(f&1023)+65536;a=String.fromCharCode(u>>18|240,u>>12&63|128,u>>6&63|128,u&63|128)}if(a!==null){i>r&&(n+=t.slice(r,i));n+=a;r=i=o+1}}i>r&&(n+=t.slice(r,s));return n}};