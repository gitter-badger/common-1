var NAILS_Admin_CMS_pages_Create_Edit;NAILS_Admin_CMS_pages_Create_Edit=function(){this.editor_id=Math.floor(Math.random()*1e16);this.search_placeholder="Search widget library";this.templates=[];this.widgets=[];this._dragging_widget=!1;this.init=function(e,t){this.templates=e;this.widgets=t;this._template_chooser_init();this._editor_init()};this._template_chooser_init=function(){$("label.template").on("click",function(){$("label.template").removeClass("selected");$(this).addClass("selected");var e=$(this).data("template-slug");$("a.launch-editor").hide();$("a.launch-editor.template-"+e).show()})};this._editor_init=function(){var e=this,t=$("<div>").attr("id",this.editor_id).addClass("group-cms pages widgeteditor ready"),n=$("<div>").attr("id",this.editor_id+"-loader").addClass("loader").html('<span class="ion-looping"></span>'),r=$("<ul>").attr("id",this.editor_id+"-header").addClass("header"),i=$("<ul>").attr("id",this.editor_id+"-widgets").addClass("widgets").disableSelection(),s=$("<li>").attr("id",this.editor_id+"-search").addClass("search").html($("#template-widget-search").html()),o=$("<ul>").attr("id",this.editor_id+"-dropzone").addClass("dropzone empty").html($("#template-dropzone-empty").html());i.append(s);var u,a,f,l,c,h,p;u=0;a=$("#template-widget-grouping").html();f=$("#template-widget").html();for(var d in this.widgets){l={name:this.widgets[d].label,group:"group-"+u};c=Mustache.render(a,l);i.append(c);for(var v in this.widgets[d].widgets){l={group:"group-"+u,name:this.widgets[d].widgets[v].label,description:this.widgets[d].widgets[v].description,keywords:this.widgets[d].widgets[v].keywords,slug:this.widgets[d].widgets[v].slug};c=Mustache.render(f,l);i.append(c);h="var _WIDGET_CALLBACKS_"+this.widgets[d].widgets[v].slug+" = function(){";h+="this.dropped = function( _WIDGETID ){";this.widgets[d].widgets[v].callbacks.dropped.length>0&&(h+=this.widgets[d].widgets[v].callbacks.dropped);h+="};";h+="this.sort_start = function( _WIDGETID ){";this.widgets[d].widgets[v].callbacks.sort_start.length>0&&(h+=this.widgets[d].widgets[v].callbacks.sort_start);h+="};";h+="this.sort_stop = function( _WIDGETID ){";this.widgets[d].widgets[v].callbacks.sort_stop.length>0&&(h+=this.widgets[d].widgets[v].callbacks.sort_stop);h+="};";h+="this.remove_start = function( _WIDGETID ){";this.widgets[d].widgets[v].callbacks.remove_start.length>0&&(h+=this.widgets[d].widgets[v].callbacks.remove_start);h+="};";h+="this.remove_stop = function( _WIDGETID ){";this.widgets[d].widgets[v].callbacks.remove_stop.length>0&&(h+=this.widgets[d].widgets[v].callbacks.remove_stop);h+="};";h+="};";h+="var _WIDGET_"+this.widgets[d].widgets[v].slug+" = new _WIDGET_CALLBACKS_"+this.widgets[d].widgets[v].slug+"();";p=$("<script>").attr("id","callbacks-"+this.widgets[d].widgets[v].slug).attr("type","text/javascript").html(h);$("body").append(p)}u++}t.append(n);t.append(r);t.append(o);t.append(i);$("body").append(t);$("a.launch-editor").on("click",function(){var t=$(this).data("template"),n=$(this).data("area");e._editor_launch(t,n);return!1})};this._editor_launch=function(e,t){$("#"+this.editor_id).removeClass("ready").show();$("body").addClass("noscroll");this._load_widgets_for_area(e,t);this._editor_construct(e,t);$("#"+this.editor_id).addClass("ready")};this._editor_construct=function(e,t){var n=this,r,i;r=this._get_template(e);r.active_area=r.widget_areas[t].title;i=$("#template-header").html();i=Mustache.render(i,r);$("#"+this.editor_id+"-header").html(i);var s=$("#template-dropzone-widget").html();$("#"+this.editor_id+"-dropzone").sortable({placeholder:"placeholder",handle:".sorter",start:function(e,t){t.placeholder.height(t.helper.height());if(t.item.hasClass("processed")){var n=t.item.attr("id"),r=t.item.data("slug");window["_WIDGET_"+r].sort_start(n)}},update:function(e,t){console.log("update",e,t);if(!t.item.hasClass("processed")){var i,o,u,a,f;i=$(t.item).data("slug");o=n._get_widget(i);u={id:"widget-editor-"+Math.floor(Math.random()*1e16),slug:i,label:o.label,description:o.description};a=Mustache.render(s,u);f=$("<li>");f.addClass("processed dropzone-widget "+u.slug);f.attr("id",u.id);f.data("slug",u.slug);f.html(a);$(".header-bar .closer",f).on("click",function(e){var t=$(this).closest("li.dropzone-widget").attr("id");n._remove_widget(t);e.stopPropagation();return!1});t.item.replaceWith(f);$("#"+n.editor_id+"-dropzone").removeClass("empty");$("#"+n.editor_id+"-dropzone li.empty").remove();var l={controller:"cms/pages",method:"widget/get_editor",data:{widget:o.slug,template:r.slug,id:u.id},success:function(e){$(f).find(".editor").html(e.HTML);window["_WIDGET_"+o.slug].dropped(u.id)},error:function(e){var t=JSON.parse(e.responseText);$(f).addClass("error").find(".editor").html('<p class="system-alert error no-close"><strong>Error:</strong> '+t.error+"</p>")}};window.NAILS.API.call(l)}},over:function(e,t){console.log("over",e,t);$("#"+n.editor_id+"-dropzone").removeClass("empty");$("#"+n.editor_id+"-dropzone li.empty").remove()},out:function(e,t){console.log("out",e,t);var r=0;r+=$("#"+n.editor_id+"-dropzone li.dropzone-widget").length;r+=$("#"+n.editor_id+"-dropzone li.widget").length;if(r<=1){var i=$("#template-dropzone-empty").html();$("#"+n.editor_id+"-dropzone").addClass("empty").append(i)}},activate:function(e,t){console.log("activate",e,t)},beforeStop:function(e,t){console.log("beforeStop",e,t)},change:function(e,t){console.log("change",e,t)},create:function(e,t){console.log("create",e,t)},deactivate:function(e,t){console.log("deactivate",e,t)},stop:function(e,t){if($("#"+n.editor_id+"-dropzone li.dropzone-widget")<=0){var r=$("#template-dropzone-empty").html();$("#"+n.editor_id+"-dropzone").addClass("empty").append(r)}else{$("#"+n.editor_id+"-dropzone").removeClass("empty");$("#"+n.editor_id+"-dropzone li.empty").remove()}if(t.item.hasClass("processed")){var i=t.item.attr("id"),s=t.item.data("slug");window["_WIDGET_"+s].sort_stop(i)}},remove:function(e,t){console.log("remove",e,t)},receive:function(e,t){console.log("receive",e,t)}});for(var o in this.widgets)for(var u in this.widgets[o].widgets){this.widgets[o].widgets[u].restrict_to_template.length&&this._array_search(e,this.widgets[o].widgets[u].restrict_to_template)===!1&&$("#"+this.editor_id+"-widgets li.widget."+this.widgets[o].widgets[u].slug).addClass("disabled");this.widgets[o].widgets[u].restrict_to_area.length&&this._array_search(t,this.widgets[o].widgets[u].restrict_to_area)===!1&&$("#"+this.editor_id+"-widgets li.widget."+this.widgets[o].widgets[u].slug).addClass("disabled");this.widgets[o].widgets[u].restrict_from_template.length&&this._array_search(e,this.widgets[o].widgets[u].restrict_from_template)!==!1&&$("#"+this.editor_id+"-widgets li.widget."+this.widgets[o].widgets[u].slug).addClass("disabled");this.widgets[o].widgets[u].restrict_from_area.length&&this._array_search(t,this.widgets[o].widgets[u].restrict_from_area)!==!1&&$("#"+this.editor_id+"-widgets li.widget."+this.widgets[o].widgets[u].slug).addClass("disabled")}$("#"+this.editor_id+"-widgets li.widget:not(.disabled)").draggable({helper:function(e){var t=$(e.currentTarget);return $("<div>").addClass("dragging-widget").text(t.data("title"))},appendTo:"#"+this.editor_id,zIndex:3,connectToSortable:"#"+this.editor_id+"-dropzone",start:function(){n._dragging_widget=!0},stop:function(){n._dragging_widget=!1}});$(document).on("keyup",function(e){!n._dragging_widget&&e.keyCode===27&&n._editor_close()});$("#"+this.editor_id+"-search a.minimiser").on("click",function(){$("#"+n.editor_id).toggleClass("minimised")});$("#"+this.editor_id+"-search input").on("keyup",function(){var e=$.trim($(this).val());e.length>0?$("#"+n.editor_id+"-widgets li.widget").each(function(){var t=$(this).data("keywords").split(","),n=new RegExp(e,"gi");if(n.test(t)){$(this).addClass("search-hit");$(this).removeClass("search-miss")}else{$(this).addClass("search-miss");$(this).removeClass("search-hit")}}):$("#"+n.editor_id+"-widgets li.widget").removeClass("search-miss search-hit")});$("#"+this.editor_id+"-widgets li.grouping").on("click",function(){$(this).toggleClass("open");var e=$(this).data("group");$("#"+n.editor_id+"-widgets li.widget."+e).toggleClass("hidden")});$("#"+this.editor_id+"-header ul.rhs a").on("click",function(){var e=$(this).data("action");switch(e){case"close":n._editor_close()}return!1})};this._editor_destruct=function(){console.log("TODO");$("body").removeClass("noscroll");$("#"+this.editor_id+"-widgets li.widget:not(.disabled)").draggable("destroy");$("#"+this.editor_id+"-widgets li.dropzone").sortable("destroy");$("#"+this.editor_id+"-widgets li.widget.disabled").removeClass("disabled");$(document).off("keyup");$("#"+this.editor_id+"-search a.minimiser").off("click");$("#"+this.editor_id+"-search input").off("keyup");$("#"+this.editor_id+"-widgets li.grouping").off("click");$("#"+this.editor_id+"-header ul.rhs a").off("click")};this._load_widgets_for_area=function(e,t){var n=$("#template-dropzone-empty").html();$("#"+this.editor_id+"-dropzone").addClass("empty").html(n);console.log("TODO",e,t)};this._remove_widget=function(e){$("<div>").text("Are you sure you wish to remove this widget from the interface?").dialog({title:"Are you sure?",resizable:!1,draggable:!1,modal:!0,dialogClass:"group-cms-editor-alert",buttons:{OK:function(){alert("Execute before remove callback");$(this).dialog("close");alert("Execute after remove callback")},Cancel:function(){$(this).dialog("close")}}});$(".ui-widget-overlay").css({zIndex:1e3})};this._editor_close=function(){$("#"+this.editor_id).hide();this._editor_destruct()};this._get_template=function(e){for(var t in this.templates)if(e===this.templates[t].slug)return this.templates[t];return!1};this._get_widget=function(e){for(var t in this.widgets)for(var n in this.widgets[t].widgets)if(e===this.widgets[t].widgets[n].slug)return this.widgets[t].widgets[n];return!1};this._array_search=function(e,t,n){var r=!!n,i="";if(t&&typeof t=="object"&&t.change_key_case)return t.search(e,n);if(typeof e=="object"&&e.exec){if(!r){var s="i"+(e.global?"g":"")+(e.multiline?"m":"")+(e.sticky?"y":"");e=new RegExp(e.source,s)}for(i in t)if(e.test(t[i]))return i;return!1}for(i in t)if(r&&t[i]===e||!r&&t[i]==e)return i;return!1}};