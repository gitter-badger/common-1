var NAILS_CDN_Manager;NAILS_CDN_Manager=function(){this.handler="";this.callback="";this.url_schemes={};this.is_fancybox="";this.reopen_fancybox="";this.init=function(e,t,n,r,i){this.handler=e;this.callback=t;this.url_schemes=n;this.is_fancybox=r;this.reopen_fancybox=i;this._init_submit();this._init_alerts();this._init_upload();this._init_delete();this._init_insert();this._init_sidebar();this._init_thumbs();this._init_search();var s=!1;this.handler==="ckeditor"?s=!0:this.is_fancybox?s=typeof parent[this.callback]=="function"?!0:!1:window.opener?s=typeof window.opener[this.callback]=="function"?!0:!1:s=!1;s||$("a.insert").remove();$("a.cdn-fancybox").fancybox({padding:0,wrapCSS:"cdn-fancybox",helpers:{title:{type:"over"}}})};this._init_submit=function(){var e=this;$("form").on("submit",function(){e._show_mask()})};this._init_alerts=function(){var e=this;$(".system-alert .awesome").on("click",function(){e._hide_alert();return!1});$(document).on("keydown",function(e){e.keyCode===13&&$("#alert:visible").length>0&&$("#alert .awesome.ok").first().click();e.keyCode===27&&$("#alert:visible").length>0&&$("#alert .awesome.cancel").first().click()})};this._init_upload=function(){};this._init_delete=function(){$("a.delete").on("click",function(){var e=$(this);$("<div>").html("<p>Any resources which are using this object will have the reference removed.</p><p>Continue?</p>").dialog({title:"Are you sure?",resizable:!1,draggable:!1,modal:!0,dialogClass:"no-close",buttons:{Delete:function(){window.location.href=e.attr("href")},Cancel:function(){$(this).dialog("close")}}});return!1})};this._init_insert=function(){var e=this;$("a.insert").on("click",function(){var t=$(this).attr("data-bucket"),n=$(this).attr("data-file"),r=$(this).attr("data-id");e.handler==="ckeditor"?e._insert_ckeditor(t,n,r):e._insert_native(t,n,r);e.is_fancybox?parent.$.fancybox.close():window.close();return!1})};this._insert_ckeditor=function(e,t,n){var r=this.url_schemes.serve,i=t.split("."),s={bucket:e,filename:i[0],extension:"."+i[1],id:n,width:0,height:0,sex:"",border:0},o=Mustache.render(r,s);window.opener.CKEDITOR.tools.callFunction(this.callback,o)};this._insert_native=function(e,t,n){this.is_fancybox?parent[this.callback].call(e,t,n,this.reopen_fancybox):window.opener[this.callback].call(e,t,n,this.reopen_fancybox)};this._init_sidebar=function(){var e=this;$("li.tag.droppable").droppable({accept:".file",hoverClass:"can-drop",tolerance:"pointer",drop:function(t,n){var r=$(n.draggable).data("id"),i=$(this).data("id"),s=$(this),o=$(n.draggable);_api.call({controller:"cdnapi",method:"add_object_tag",action:"GET",data:{object_id:r,tag_id:i},success:function(t){e._add_tag_ok(s,o,t)},error:function(t){e._add_tag_fail(s,o,t)}});$(this).find(".count").addClass("saving")}});$("div.remove-object-tag").droppable({accept:".file",hoverClass:"can-drop",tolerance:"pointer",drop:function(t,n){var r=$(n.draggable).data("id"),i=$(this).data("id"),s=$(this),o=$(n.draggable);_api.call({controller:"cdnapi",method:"delete_object_tag",action:"GET",data:{object_id:r,tag_id:i},success:function(t){e._remove_tag_ok(s,o,t)},error:function(t){e._remove_tag_fail(s,o,t)}});$(this).find(".count").addClass("saving")}})};this._add_tag_ok=function(e,t,n){e.find(".count").text(n.new_total).removeClass("saving")};this._add_tag_fail=function(e,t,n){var r=JSON.parse(n.responseText);alert(r.error);e.find(".count").removeClass("saving")};this._remove_tag_ok=function(e,t,n){t.remove();e.removeClass("saving");$("li.tag.selected .count").text(n.new_total)};this._remove_tag_fail=function(e,t,n){var r=JSON.parse(n.responseText);alert(r.error);e.removeClass("saving")};this._init_thumbs=function(){$(".file").draggable({helper:"clone",start:function(e,t){$(t.helper).addClass("clone")}})};this._init_search=function(){var e=this;$("#search-text").on("keyup",function(){e._do_search($(this).val());return!1})};this._do_search=function(e){$("li.file,tr.file:not(.head)").each(function(){var t=new RegExp(e,"gi");t.test($(this).attr("data-title"))?$(this).show():$(this).hide()})};this._show_mask=function(){$("#mask").show()};this._hide_mask=function(){$("#mask").hide()};this._show_alert=function(){$("#alert").show()};this._hide_alert=function(){$("#alert").hide()}};