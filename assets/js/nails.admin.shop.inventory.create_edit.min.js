var NAILS_Admin_Shop_Inventory_Create_Edit;NAILS_Admin_Shop_Inventory_Create_Edit=function(){this.mode=null;this.product_types=[];this.upload_token=null;this._variation_counter=0;this.init=function(e,t,n){this.mode=e;this.product_types=t;this.upload_token=n;this._init_info();this._init_variations();this._init_gallery();this._init_attributes();this._init_chosens();this._init_submit()};this._init_info=function(){this.info_chosen_type_change()};this.info_chosen_type_change=function(){var e=$("#tab-basics select[name=type_id]").val(),t=$("<div>").html($.parseHTML($.trim($("#template-variation").html(),null,!0)));$(".meta-fields").hide();$(".meta-fields-"+e).show();$(".meta-fields",t).hide();$(".meta-fields-"+e,t).show();this._variations_checkmax();var n=0;for(var r in this.product_types)this.product_types[r].id===e&&(n=parseInt(this.product_types[r].is_physical,10));if(!n){$("li.tab a.tabber-variation-shipping").addClass("disabled").hide();$(".fields-is-physical .physical-fields").hide();$(".fields-is-physical .no-dimensions").show();$("li.tab a.tabber-variation-shipping").each(function(){var e=$(this);if(e.parent().hasClass("active")){var t=e.closest("ul").find("a.tabber-variation-details");e.parent().removeClass("active");t.parent().addClass("active");$("#"+e.data("tab")).hide();$("#"+t.data("tab")).show()}});$("li.tab a.tabber-variation-shipping",t).addClass("disabled").hide();$(".fields-is-physical .physical-fields",t).hide();$(".fields-is-physical .no-dimensions",t).show()}else{$("li.tab a.tabber-variation-shipping").removeClass("disabled").css("display","inline-block");$(".fields-is-physical .physical-fields").show();$(".fields-is-physical .no-dimensions").hide();$("li.tab a.tabber-variation-shipping",t).removeClass("disabled").css("display","inline-block");$(".fields-is-physical .physical-fields",t).show();$(".fields-is-physical .no-dimensions",t).hide()}$("#template-variation").html($(t).html())};this._init_variations=function(){var e=this;$("#product-variation-add").on("click",function(){var t=$("#template-variation").html().replace('<!--script type="text/javascript"-->','<script type="text/javascript">').replace("<!--/script-->","</script>"),n=$("#product-variations .variation").length;t=Mustache.render(t,{counter:n});$("#product-variations").append(t);_nails.add_stripes();_nails.process_prefixed_inputs();_nails_admin.init_toggles();e._variations_checkmax();$("#variation-sync-prices").show();$("#sync-shipping-options").show();return!1});$("#product-variations").on("click","a.delete",function(){var t=this;$("#dialog-confirm-delete").dialog({resizable:!1,draggable:!1,modal:!0,dialogClass:"no-close",buttons:{"Delete Variation":function(){$(t).closest(".variation").remove();e._variations_checkmax();if($("product-variations .variation").length<=1){$("#variation-sync-prices").hide();$("#sync-shipping-options").hide()}$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}}});return!1});$("#product-variations").on("click","ul.gallery-associations li:not(.actions)",function(e){e.preventDefault();var t=$("input:checked",this).length?!0:!1;$("input",this).prop("checked",!t);if(t){$(this).removeClass("selected");$("input",this).prop("checked",!1)}else{$(this).addClass("selected");$("input",this).prop("checked",!0)}return!1});$("#product-variations").on("click","ul.gallery-associations a.action",function(){switch($(this).data("function")){case"all":$(this).closest("ul.gallery-associations").find("li.image:not(.selected)").click();break;case"none":$(this).closest("ul.gallery-associations").find("li.image.selected").click();break;case"toggle":$(this).closest("ul.gallery-associations").find("li.image").click()}return!1});$("#product-variations").on("click","ul.gallery-associations.empty li.empty a",function(){$("#tabber-gallery").click();return!1});$(document).on("click","#add-shipping-option",function(){var t=$("#template-shipping-option").html(),n=$("#variation-"+$(this).data("variation-counter")),r=$("tr.shipping-option",n).length;t=Mustache.render(t,{counter:r+1});$("table.shipping-options tbody",n).append(t);$("table.shipping-options",n).removeClass("empty");_nails.add_stripes();_nails.process_prefixed_inputs();e._init_chosens();return!1});$("#product-variations").on("click","a.delete-shipping",function(){var e=this;$("#dialog-confirm-delete").dialog({resizable:!1,draggable:!1,modal:!0,dialogClass:"no-close",buttons:{"Delete Option":function(){$(e).closest("table.shipping-options").find("tr.shipping-option").length===1&&$(e).closest("table.shipping-options").addClass("empty");$(e).closest("tr.shipping-option").remove();$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}}});return!1});$("#variation-sync-prices a").on("click",function(){$("<div>").html("This action will take the values form the first variation and <strong>overwrite</strong> the corresponding values in each other variation.").dialog({title:"Confirm Sync",resizable:!1,draggable:!1,modal:!0,dialogClass:"no-close",buttons:{OK:function(){$("#variation-0 .base-price").each(function(){var e=$(this).data("code");$("#product-variations .variation-price."+e).val($(this).val())});$("#variation-0 .base-price-sale").each(function(){var e=$(this).data("code");$("#product-variations .variation-price-sale."+e).val($(this).val())});$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}}});return!1});$("#sync-shipping-options").on("click",function(){$("<div>").html("This action will take the values form the first variation and <strong>overwrite</strong> the corresponding values in each other variation.").dialog({title:"Confirm Sync",resizable:!1,draggable:!1,modal:!0,dialogClass:"no-close",buttons:{OK:function(){alert("TODO");$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}}});return!1})};this._variations_checkmax=function(){var e=$("#tab-basics select[name=type_id]").val(),t=0;for(var n in this.product_types)this.product_types[n].id===e&&(t=parseInt(this.product_types[n].max_variations,10));if(t!==0&&$("#product-variations .variation").length>=t){$(".add-variation-button").removeClass("enabled").addClass("disabled");$("#product-variations .variation:gt("+(t-1)+")").addClass("not-applicable")}else{$(".add-variation-button").removeClass("disabled").addClass("enabled");$("#product-variations .variation.not-applicable").removeClass("not-applicable")}};this._init_gallery=function(){var e=this;$("#file_upload").uploadify({debug:!1,auto:!0,swf:SITE_URL+"vendor/shed/nails/assets/swf/jquery.uploadify/uploadify.swf",queueID:"gallery-items",uploader:SITE_URL+"api/cdnapi/object_create/script.php",fileSizeLimit:2048,fileObjName:"upload",fileTypeExts:"*.gif; *.jpg; *.png",formData:{token:this.upload_token,bucket:"shop-product-images","return":"URL|THUMB|100x100,34x34"},itemTemplate:$("#template-uploadify").html(),onSelect:function(){$("#gallery-items li.gallery-item").length&&$("#gallery-items li.empty").fadeOut(250,function(){$(this).parent().removeClass("empty")})},onUploadStart:function(){$("#product-form").off("submit");$("#product-form").on("submit",function(){return!1});var e="Uploading...",t=$("#product-form input[type=submit]").val();window.onbeforeunload=function(){return"Uploads are in progress. Leaving this page will cause them to stop."};$("ul.tabs li a").addClass("disabled");$("#upload-message").show();t!==e&&$("#product-form input[type=submit]").attr({"data-old_val":t,disabled:"disabled"}).val("Uploading...")},onQueueComplete:function(){$("#product-form").off("submit");e._init_submit();$("#product-form input[type=submit]").removeAttr("disabled").val($("#product-form input[type=submit]").data("old_val"));window.onbeforeunload=null;$("ul.tabs li a").removeClass("disabled");$("#upload-message").hide()},onUploadProgress:function(e,t,n){var r=t/n*100;$("#"+e.id+" .progress").css("height",r+"%")},onUploadSuccess:function(e,t){var n=JSON.parse(t),r=$.trim($("#template-gallery-item").html()),i=$($.parseHTML(r));i.attr("id",e.id+"-complete");$("#"+e.id).replaceWith(i);var s=$("#"+e.id+"-complete");if(!s.length){r=$.trim($("#template-gallery-item").html());i=$($.parseHTML(r));i.attr("id",e.id+"-complete");$("#"+e.id).replaceWith(i);s=$("#"+e.id+"-complete")}if(n.status===200){var o=$("<img>").attr("src",n.object_url[0]).on("load",function(){s.removeClass("crunching")}),u=$("<a>").attr({href:"#","class":"delete","data-object_id":n.object_id});s.append(o).append(u).find("input").val(n.object_id);o=$("<img>").attr({src:n.object_url[1]});var a=$("<input>").attr({type:"checkbox",value:n.object_id}),f=$("<li>").addClass("image object-id-"+n.object_id).append(a).append(o);$("#product-variations .variation").each(function(){a.attr("name","variation["+$(this).data("counter")+"][gallery][]");$("ul.gallery-associations",this).removeClass("empty");f.clone().insertBefore($("ul.gallery-associations li.actions",this))});var l=$("<div>").html($.parseHTML($.trim($("#template-variation").html(),null,!0)));a.attr("name","variation[{{counter}}][gallery][]");$("ul.gallery-associations",l).removeClass("empty");f.clone().insertBefore($("ul.gallery-associations li.actions",l));$("#template-variation").html($(l).html())}else{var c=$("<p>").addClass("filename").text(e.name),h=$("<p>").addClass("message").text(n.error);s.addClass("error").append(c).append(h).removeClass("crunching")}},onUploadError:function(e,t,n,r){var i=$("#"+e.id+"-complete");if(!i.length){var s=$.trim($("#template-gallery-item").html()),o=$($.parseHTML(s));o.attr("id",e.id+"-complete");$("#"+e.id).replaceWith(o);i=$("#"+e.id+"-complete")}var u=$("<p>").addClass("filename").text(e.name),a=$("<p>").addClass("message").text(r);i.addClass("error").append(u).append(a).removeClass("crunching")}});$("#tab-gallery").on("click","a.switch-to-variations",function(){$("#tabber-variations").click();return!1});$("#gallery-items").disableSelection().sortable({placeholder:"gallery-item placeholder",items:"li.gallery-item",stop:function(){var e=[];$("#gallery-items li.gallery-item:not(.deleted,.crunching) input[type=hidden]").each(function(){e.push(parseInt($(this).val(),10))});var t=$("<div>").html($.parseHTML($.trim($("#template-variation").html(),null,!0)));$.each(e,function(e,n){$("li.image.object-id-"+n).each(function(){var e=$(this).closest("ul.gallery-associations");$(this).clone().appendTo(e);$(this).remove()});$("li.image.object-id-"+n,t).each(function(){var e=$(this).closest("ul.gallery-associations");$(this).clone().appendTo(e);$(this).remove()})});$("ul.gallery-associations li.actions").each(function(){var e=$(this).closest("ul.gallery-associations");$(this).clone().appendTo(e);$(this).remove()});$("ul.gallery-associations li.actions",t).each(function(){var e=$(this).closest("ul.gallery-associations");$(this).clone().appendTo(e);$(this).remove()});$("#template-variation").html($(t).html())}});$(document).on("click","#gallery-items .gallery-item .remove",function(){var e=$(this).data("instance_id"),t=$(this).data("file_id");$("#"+e).uploadify("cancel",t);$("#"+t+" .data-cancel").text("Cancelled").show();$("#"+t).addClass("cancelled");if($("#gallery-items li.gallery-item:not(.cancelled)").length===0){$("#gallery-items").addClass("empty");$("#gallery-items li.empty").css("opacity",0).delay(1e3).animate({opacity:1},250)}return!1});$(document).on("click","#gallery-items .gallery-item .delete",function(){var e=this;$("#dialog-confirm-delete").dialog({resizable:!1,draggable:!1,modal:!0,dialogClass:"no-close",buttons:{"Delete Image":function(){var t=$(e).data("object_id"),n={controller:"cdnapi",method:"object_delete",action:"POST",data:{object_id:t}};window.NAILS.API.call(n);$(e).closest("li.gallery-item").addClass("deleted").fadeOut("slow",function(){$(e).remove()});$(".image.object-id-"+t).remove();var r=$("<div>").html($.parseHTML($.trim($("#template-variation").html(),null,!0)));$(".image.object-id-"+t,r).remove();if($("#gallery-items li.gallery-item:not(.deleted)").length===0){$("#gallery-items").addClass("empty");$("#gallery-items li.empty").css("opacity",0).delay(1e3).animate({opacity:1},250);$("ul.gallery-associations").addClass("empty");$("ul.gallery-associations",r).addClass("empty")}$("#template-variation").html($(r).html());$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}}});return!1})};this._init_attributes=function(){var e=this;$("#product-attribute-add").on("click",function(){var t=$("#template-attribute").html(),n=$("#product-attributes tr.attribute").length;t=Mustache.render(t,{counter:n});$("#product-attributes").append(t);e._init_chosens();return!1});$("#product-attributes").on("click","a.delete",function(){$(this).closest("tr.attribute").remove();return!1})};this._init_chosens=function(){var e=this,t={},n={};t.types="#tab-basics select.type_id";n.types=SITE_URL+"admin/shop/manage/types?is_fancybox=1";t.brands="#tab-basics select.brands";n.brands=SITE_URL+"admin/shop/manage/brands?is_fancybox=1";t.categories="#tab-basics select.categories";n.categories=SITE_URL+"admin/shop/manage/categories?is_fancybox=1";t.tags="#tab-basics select.tags";n.tags=SITE_URL+"admin/shop/manage/tags?is_fancybox=1";t.tax_rates="#tab-basics select.tax_rate_id";n.tax_rates=SITE_URL+"admin/shop/manage/tax_rates?is_fancybox=1";t.attributes="#tab-attributes select.attributes";n.attributes=SITE_URL+"admin/shop/manage/attributes?is_fancybox=1";t.ranges="#tab-ranges-collections select.ranges";n.ranges=SITE_URL+"admin/shop/manage/ranges?is_fancybox=1";t.collections="#tab-ranges-collections select.collections";n.collections=SITE_URL+"admin/shop/manage/collections?is_fancybox=1";t.courier_method="#tab-variations select.shipping_methods";n.courier_method=SITE_URL+"admin/shop/manage/shipping_methods?is_fancybox=1";$(t.types).chosen({footer_html:'<a href="#" class="manage-types">Manage Product Types</a>',width:"100%"}).change(function(){e.info_chosen_type_change()});$(t.brands).chosen({footer_html:'<a href="#" class="manage-brands">Manage Brands</a>',width:"100%"});$(t.categories).chosen({footer_html:'<a href="#" class="manage-categories">Manage Categories</a>',width:"100%"});$(t.tags).chosen({footer_html:'<a href="#" class="manage-tags">Manage Tags</a>',width:"100%"});$(t.tax_rates).chosen({footer_html:'<a href="#" class="manage-tax-rates">Manage Tax Rates</a>',width:"100%"});$(t.attributes).chosen({footer_html:'<a href="#" class="manage-attributes">Manage Attributes</a>',width:"100%"});$(t.ranges).chosen({footer_html:'<a href="#" class="manage-ranges">Manage Ranges</a>',width:"100%"});$(t.collections).chosen({footer_html:'<a href="#" class="manage-collections">Manage Collections</a>',width:"100%"});$(document).on("click","a.manage-types",function(){$.fancybox.open(n.types,{type:"iframe",width:"95%",height:"95%",beforeClose:function(){e._rebuild_chosen(t.types)}});return!1});$(document).on("click","a.manage-brands",function(){$.fancybox.open(n.brands,{type:"iframe",width:"95%",height:"95%",beforeClose:function(){e._rebuild_chosen(t.brands)}});return!1});$(document).on("click","a.manage-categories",function(){$.fancybox.open(n.categories,{type:"iframe",width:"95%",height:"95%",beforeClose:function(){e._rebuild_chosen(t.categories)}});return!1});$(document).on("click","a.manage-tags",function(){$.fancybox.open(n.tags,{type:"iframe",width:"95%",height:"95%",beforeClose:function(){e._rebuild_chosen(t.tags)}});return!1});$(document).on("click","a.manage-tax-rates",function(){$.fancybox.open(n.tax_rates,{type:"iframe",width:"95%",height:"95%",beforeClose:function(){e._rebuild_chosen(t.tax_rates)}});return!1});$(document).on("click","a.manage-attributes",function(){$.fancybox.open(n.attributes,{type:"iframe",width:"95%",height:"95%",beforeClose:function(){e._rebuild_chosen(t.attributes,"template-attribute")}});return!1});$(document).on("click","a.manage-ranges",function(){$.fancybox.open(n.ranges,{type:"iframe",width:"95%",height:"95%",beforeClose:function(){e._rebuild_chosen(t.ranges)}});return!1});$(document).on("click","a.manage-collections",function(){$.fancybox.open(n.collections,{type:"iframe",width:"95%",height:"95%",beforeClose:function(){e._rebuild_chosen(t.collections)}});return!1});$("ul.tabs a:not(.disabled)").on("click",function(){setTimeout(function(){$(t.types).trigger("chosen:updated");$(t.brands).trigger("chosen:updated");$(t.categories).trigger("chosen:updated");$(t.tags).trigger("chosen:updated");$(t.tax_rates).trigger("chosen:updated");$(t.attributes).trigger("chosen:updated");$(t.ranges).trigger("chosen:updated");$(t.collections).trigger("chosen:updated")},1)})};this._rebuild_chosen=function(e,t){var n=$(".fancybox-iframe").get(0).contentWindow._DATA;if(typeof n=="undefined")return!1;var r=$(e);if(!r.length)return!1;r.each(function(){var e=this,t=[];$("option:selected",this).each(function(){t.push(parseInt($(this).val(),10))});$(this).empty();$.each(n,function(){var n=$("<option>");n.val(this.id);n.html(this.label);$.inArray(this.id,t)>-1&&n.prop("selected",!0);$(e).append(n)});$(this).trigger("chosen:updated")});if(t){var i=$("<div>").html($.parseHTML($.trim($("#"+t).html(),null,!0))),s=$("select",i).empty();$.each(n,function(){var e=$("<option>");e.val(this.id);e.html(this.label);$(s).append(e)});$("#"+t).html($(i).html())}};this._init_submit=function(){var e=this;$("#product-form").on("submit",function(){return e._submit()})};this._submit=function(){return!0}};