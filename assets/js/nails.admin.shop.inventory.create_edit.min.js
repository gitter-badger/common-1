var NAILS_Admin_Shop_Inventory_Create_Edit;NAILS_Admin_Shop_Inventory_Create_Edit=function(){this.mode=null,this.product_types=[],this.upload_token=null,this._api=null,this._variation_counter=0,this.init=function(t,e,a){this.mode=t,this.product_types=e,this.upload_token=a,this._api=new window.NAILS_API,console.log(this._api),this._init_info(),this._init_variations(),this._init_gallery(),this._init_attributes(),this._init_chosens(),this._init_submit()},this._init_info=function(){this.info_chosen_type_change()},this.info_chosen_type_change=function(){var t=parseInt($("#tab-basics .type_id:input").val(),10),e=$("<div>").html($.parseHTML($.trim($("#template-variation").html(),null,!0)));$(".meta-fields").hide(),$(".meta-fields-"+t).show(),$(".meta-fields",e).hide(),$(".meta-fields-"+t,e).show(),this._variations_checkmax();var a=!1;for(var i in this.product_types)if(this.product_types[i].id===t){a=this.product_types[i].is_physical;break}a?($("li.tab a.tabber-variation-shipping").removeClass("disabled").css("display","inline-block"),$("li.tab a.tabber-variation-shipping",e).removeClass("disabled").css("display","inline-block")):($("li.tab a.tabber-variation-shipping").addClass("disabled").hide(),$("li.tab a.tabber-variation-shipping").each(function(){var t=$(this);if(t.parent().hasClass("active")){var e=t.closest("ul").find("a.tabber-variation-details");t.parent().removeClass("active"),e.parent().addClass("active"),$("#"+t.data("tab")).hide(),$("#"+e.data("tab")).show()}}),$("li.tab a.tabber-variation-shipping",e).addClass("disabled").hide()),$("#template-variation").html($(e).html())},this._init_variations=function(){var t=this;$("#product-variation-add").on("click",function(){var e=$("#template-variation").html().replace('<!--script type="text/javascript"-->','<script type="text/javascript">').replace("<!--/script-->","</script>"),a=$("#product-variations .variation").length;return e=Mustache.render(e,{counter:a}),$("#product-variations").append(e),_nails.add_stripes(),_nails.process_prefixed_inputs(),_nails_admin.init_toggles(),t._variations_checkmax(),$("#variation-sync-prices").show(),$("#sync-shipping-options").show(),!1}),$("#product-variations").on("click","a.delete",function(){var e=this;return $("#dialog-confirm-delete").dialog({resizable:!1,draggable:!1,modal:!0,dialogClass:"no-close",buttons:{"Delete Variation":function(){$(e).closest(".variation").remove(),t._variations_checkmax(),$("product-variations .variation").length<=1&&($("#variation-sync-prices").hide(),$("#sync-shipping-options").hide()),$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}}}),!1}),$("#product-variations").on("change","select.stock-status",function(){t._variation_stock_status_change($(this))}),$("#product-variations").on("click","ul.gallery-associations li:not(.actions)",function(t){t.preventDefault();var e=$("input:checked",this).length?!0:!1;return $("input",this).prop("checked",!e),e?($(this).removeClass("selected"),$("input",this).prop("checked",!1)):($(this).addClass("selected"),$("input",this).prop("checked",!0)),!1}),$("#product-variations").on("click","ul.gallery-associations a.action",function(){switch($(this).data("function")){case"all":$(this).closest("ul.gallery-associations").find("li.image:not(.selected)").click();break;case"none":$(this).closest("ul.gallery-associations").find("li.image.selected").click();break;case"toggle":$(this).closest("ul.gallery-associations").find("li.image").click()}return!1}),$("#product-variations").on("click","ul.gallery-associations.empty li.empty a",function(){return $("#tabber-gallery").click(),!1}),$(document).on("click","#add-shipping-option",function(){var e=$("#template-shipping-option").html(),a=$("#variation-"+$(this).data("variation-counter")),i=$("tr.shipping-option",a).length;return e=Mustache.render(e,{counter:i+1}),$("table.shipping-options tbody",a).append(e),$("table.shipping-options",a).removeClass("empty"),_nails.add_stripes(),_nails.process_prefixed_inputs(),t._init_chosens(),!1}),$("#product-variations").on("click","a.delete-shipping",function(){var t=this;return $("#dialog-confirm-delete").dialog({resizable:!1,draggable:!1,modal:!0,dialogClass:"no-close",buttons:{"Delete Option":function(){1===$(t).closest("table.shipping-options").find("tr.shipping-option").length&&$(t).closest("table.shipping-options").addClass("empty"),$(t).closest("tr.shipping-option").remove(),$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}}}),!1}),$("input.base-price, input.variation-price").on("blur",function(){var t=$(this).val(),e=$(this).closest("tr").find("input.base-price-sale, input.variation-price");0===$.trim(e.val()).length&&e.val(t)}),$("#variation-sync-prices a").on("click",function(){return $("<div>").html("This action will take the values form the first variation and <strong>overwrite</strong> the corresponding values in each other variation.").dialog({title:"Confirm Sync",resizable:!1,draggable:!1,modal:!0,dialogClass:"no-close",buttons:{OK:function(){$("#variation-0 .base-price").each(function(){var t=$(this).data("code");$("#product-variations .variation-price."+t).val($(this).val())}),$("#variation-0 .base-price-sale").each(function(){var t=$(this).data("code");$("#product-variations .variation-price-sale."+t).val($(this).val())}),$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}}}),!1}),$("#sync-shipping-options").on("click",function(){return $("<div>").html("This action will take the values form the first variation and <strong>overwrite</strong> the corresponding values in each other variation.").dialog({title:"Confirm Sync",resizable:!1,draggable:!1,modal:!0,dialogClass:"no-close",buttons:{OK:function(){alert("TODO"),$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}}}),!1})},this._variations_checkmax=function(){var t=$("#tab-basics select[name=type_id]").val(),e=0;for(var a in this.product_types)this.product_types[a].id===t&&(e=parseInt(this.product_types[a].max_variations,10));0!==e&&$("#product-variations .variation").length>=e?($(".add-variation-button").removeClass("enabled").addClass("disabled"),$("#product-variations .variation:gt("+(e-1)+")").addClass("not-applicable")):($(".add-variation-button").removeClass("disabled").addClass("enabled"),$("#product-variations .variation.not-applicable").removeClass("not-applicable"))},this._variation_stock_status_change=function(t){var e=t.closest(".variation");e.find("div.stock-status-field").hide(),e.find("div.stock-status-field."+t.val()).show()},this._init_gallery=function(){var t=this;$("#file_upload").uploadify({debug:!1,auto:!0,swf:window.SITE_URL+"vendor/shed/nails/assets/swf/jquery.uploadify/uploadify.swf",queueID:"gallery-items",uploader:window.SITE_URL+"api/cdnapi/object_create/script.php",fileSizeLimit:2048,fileObjName:"upload",fileTypeExts:"*.gif; *.jpg; *.jpeg; *.png",formData:{token:this.upload_token,bucket:"shop-product-images","return":"URL|THUMB|100x100,34x34"},itemTemplate:$("#template-uploadify").html(),onSelect:function(){$("#gallery-items li.gallery-item").length&&$("#gallery-items li.empty").fadeOut(250,function(){$(this).parent().removeClass("empty")})},onUploadStart:function(){$("#product-form").off("submit"),$("#product-form").on("submit",function(){return!1});var t="Uploading...",e=$("#product-form input[type=submit]").val();window.onbeforeunload=function(){return"Uploads are in progress. Leaving this page will cause them to stop."},$("ul.tabs li a").addClass("disabled"),$("#upload-message").show(),e!==t&&$("#product-form input[type=submit]").attr({"data-old_val":e,disabled:"disabled"}).val("Uploading...")},onQueueComplete:function(){$("#product-form").off("submit"),t._init_submit(),$("#product-form input[type=submit]").removeAttr("disabled").val($("#product-form input[type=submit]").data("old_val")),window.onbeforeunload=null,$("ul.tabs li a").removeClass("disabled"),$("#upload-message").hide()},onUploadProgress:function(t,e,a){var i=e/a*100;$("#"+t.id+" .progress").css("height",i+"%")},onUploadSuccess:function(t,e){var a;try{a=JSON.parse(e)}catch(i){a={}}var s=$.trim($("#template-gallery-item").html()),n=$($.parseHTML(s));n.attr("id",t.id+"-complete"),$("#"+t.id).replaceWith(n);var o=$("#"+t.id+"-complete");if(o.length||(s=$.trim($("#template-gallery-item").html()),n=$($.parseHTML(s)),n.attr("id",t.id+"-complete"),$("#"+t.id).replaceWith(n),o=$("#"+t.id+"-complete")),200===a.status){var l=$("<img>").attr("src",a.object_url[0]).on("load",function(){o.removeClass("crunching")}),r=$("<a>").attr({href:"#","class":"delete","data-object_id":a.object_id});o.append(l).append(r).find("input").val(a.object_id),l=$("<img>").attr({src:a.object_url[1]});var c=$("<input>").attr({type:"checkbox",value:a.object_id}),d=$("<li>").addClass("image object-id-"+a.object_id).append(c).append(l);$("#product-variations .variation").each(function(){c.attr("name","variation["+$(this).data("counter")+"][gallery][]"),$("ul.gallery-associations",this).removeClass("empty"),d.clone().insertBefore($("ul.gallery-associations li.actions",this))});var p=$("<div>").html($.parseHTML($.trim($("#template-variation").html(),null,!0)));c.attr("name","variation[{{counter}}][gallery][]"),$("ul.gallery-associations",p).removeClass("empty"),d.clone().insertBefore($("ul.gallery-associations li.actions",p)),$("#template-variation").html($(p).html())}else{var h=$("<p>").addClass("filename").text(t.name),u=$("<p>").addClass("message").text(a.error);o.addClass("error").append(h).append(u).removeClass("crunching")}},onUploadError:function(t,e,a,i){var s=$("#"+t.id+"-complete");if(!s.length){var n=$.trim($("#template-gallery-item").html()),o=$($.parseHTML(n));o.attr("id",t.id+"-complete"),$("#"+t.id).replaceWith(o),s=$("#"+t.id+"-complete")}var l=$("<p>").addClass("filename").text(t.name),r=$("<p>").addClass("message").text(i);s.addClass("error").append(l).append(r).removeClass("crunching")}}),$("#tab-gallery").on("click","a.switch-to-variations",function(){return $("#tabber-variations").click(),!1}),$("#gallery-items").disableSelection().sortable({placeholder:"gallery-item placeholder",items:"li.gallery-item",stop:function(){var t=[];$("#gallery-items li.gallery-item:not(.deleted,.crunching) input[type=hidden]").each(function(){t.push(parseInt($(this).val(),10))});var e=$("<div>").html($.parseHTML($.trim($("#template-variation").html(),null,!0)));$.each(t,function(t,a){$("li.image.object-id-"+a).each(function(){var t=$(this).closest("ul.gallery-associations");$(this).clone().appendTo(t),$(this).remove()}),$("li.image.object-id-"+a,e).each(function(){var t=$(this).closest("ul.gallery-associations");$(this).clone().appendTo(t),$(this).remove()})}),$("ul.gallery-associations li.actions").each(function(){var t=$(this).closest("ul.gallery-associations");$(this).clone().appendTo(t),$(this).remove()}),$("ul.gallery-associations li.actions",e).each(function(){var t=$(this).closest("ul.gallery-associations");$(this).clone().appendTo(t),$(this).remove()}),$("#template-variation").html($(e).html())}}),$(document).on("click","#gallery-items .gallery-item .remove",function(){var t=$(this).data("instance_id"),e=$(this).data("file_id");return $("#"+t).uploadify("cancel",e),$("#"+e+" .data-cancel").text("Cancelled").show(),$("#"+e).addClass("cancelled"),0===$("#gallery-items li.gallery-item:not(.cancelled)").length&&($("#gallery-items").addClass("empty"),$("#gallery-items li.empty").css("opacity",0).delay(1e3).animate({opacity:1},250)),!1}),$(document).on("click","#gallery-items .gallery-item .delete",function(){var e=this;return $("#dialog-confirm-delete").dialog({resizable:!1,draggable:!1,modal:!0,dialogClass:"no-close",buttons:{"Delete Image":function(){var a=$(e).data("object_id"),i={controller:"cdnapi",method:"object_delete",action:"POST",data:{object_id:a}};t._api.call(i),$(e).closest("li.gallery-item").addClass("deleted").fadeOut("slow",function(){$(e).closest("li.gallery-item").remove()}),$(".image.object-id-"+a).remove();var s=$("<div>").html($.parseHTML($.trim($("#template-variation").html(),null,!0)));$(".image.object-id-"+a,s).remove(),0===$("#gallery-items li.gallery-item:not(.deleted)").length&&($("#gallery-items").addClass("empty"),$("#gallery-items li.empty").css("opacity",0).delay(1e3).animate({opacity:1},250),$("ul.gallery-associations").addClass("empty"),$("ul.gallery-associations",s).addClass("empty")),$("#template-variation").html($(s).html()),$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}}}),!1})},this._init_attributes=function(){var t=this;$("#product-attribute-add").on("click",function(){var e=$("#template-attribute").html(),a=$("#product-attributes tr.attribute").length;return e=Mustache.render(e,{counter:a}),$("#product-attributes").append(e),t._init_chosens(),!1}),$("#product-attributes").on("click","a.delete",function(){return $(this).closest("tr.attribute").remove(),!1})},this._init_chosens=function(){var t=this,e={},a={};e.types="#tab-basics select.type_id",a.types=window.SITE_URL+"admin/shop/manage/types?is_fancybox=1",e.brands="#tab-basics select.brands",a.brands=window.SITE_URL+"admin/shop/manage/brands?is_fancybox=1",e.categories="#tab-basics select.categories",a.categories=window.SITE_URL+"admin/shop/manage/categories?is_fancybox=1",e.tags="#tab-basics select.tags",a.tags=window.SITE_URL+"admin/shop/manage/tags?is_fancybox=1",e.tax_rates="#tab-basics select.tax_rate_id",a.tax_rates=window.SITE_URL+"admin/shop/manage/tax_rates?is_fancybox=1",e.attributes="#tab-attributes select.attributes",a.attributes=window.SITE_URL+"admin/shop/manage/attributes?is_fancybox=1",e.ranges="#tab-ranges-collections select.ranges",a.ranges=window.SITE_URL+"admin/shop/manage/ranges?is_fancybox=1",e.collections="#tab-ranges-collections select.collections",a.collections=window.SITE_URL+"admin/shop/manage/collections?is_fancybox=1",e.courier_method="#tab-variations select.shipping_methods",a.courier_method=window.SITE_URL+"admin/shop/manage/shipping_methods?is_fancybox=1",$(e.types).chosen({footer_html:'<a href="#" class="manage-types">Manage Product Types</a>',width:"100%"}).change(function(){t.info_chosen_type_change()}),$(e.brands).chosen({footer_html:'<a href="#" class="manage-brands">Manage Brands</a>',width:"100%"}),$(e.categories).chosen({footer_html:'<a href="#" class="manage-categories">Manage Categories</a>',width:"100%"}),$(e.tags).chosen({footer_html:'<a href="#" class="manage-tags">Manage Tags</a>',width:"100%"}),$(e.tax_rates).chosen({footer_html:'<a href="#" class="manage-tax-rates">Manage Tax Rates</a>',width:"100%"}),$(e.attributes).chosen({footer_html:'<a href="#" class="manage-attributes">Manage Attributes</a>',width:"100%"}),$(e.ranges).chosen({footer_html:'<a href="#" class="manage-ranges">Manage Ranges</a>',width:"100%"}),$(e.collections).chosen({footer_html:'<a href="#" class="manage-collections">Manage Collections</a>',width:"100%"}),$(document).on("click","a.manage-types",function(){return $.fancybox.open(a.types,{type:"iframe",width:"95%",height:"95%",beforeClose:function(){t._rebuild_chosen(e.types)}}),!1}),$(document).on("click","a.manage-brands",function(){return $.fancybox.open(a.brands,{type:"iframe",width:"95%",height:"95%",beforeClose:function(){t._rebuild_chosen(e.brands)}}),!1}),$(document).on("click","a.manage-categories",function(){return $.fancybox.open(a.categories,{type:"iframe",width:"95%",height:"95%",beforeClose:function(){t._rebuild_chosen(e.categories)}}),!1}),$(document).on("click","a.manage-tags",function(){return $.fancybox.open(a.tags,{type:"iframe",width:"95%",height:"95%",beforeClose:function(){t._rebuild_chosen(e.tags)}}),!1}),$(document).on("click","a.manage-tax-rates",function(){return $.fancybox.open(a.tax_rates,{type:"iframe",width:"95%",height:"95%",beforeClose:function(){t._rebuild_chosen(e.tax_rates)}}),!1}),$(document).on("click","a.manage-attributes",function(){return $.fancybox.open(a.attributes,{type:"iframe",width:"95%",height:"95%",beforeClose:function(){t._rebuild_chosen(e.attributes,"template-attribute")}}),!1}),$(document).on("click","a.manage-ranges",function(){return $.fancybox.open(a.ranges,{type:"iframe",width:"95%",height:"95%",beforeClose:function(){t._rebuild_chosen(e.ranges)}}),!1}),$(document).on("click","a.manage-collections",function(){return $.fancybox.open(a.collections,{type:"iframe",width:"95%",height:"95%",beforeClose:function(){t._rebuild_chosen(e.collections)}}),!1}),$("ul.tabs a:not(.disabled)").on("click",function(){setTimeout(function(){$(e.types).trigger("chosen:updated"),$(e.brands).trigger("chosen:updated"),$(e.categories).trigger("chosen:updated"),$(e.tags).trigger("chosen:updated"),$(e.tax_rates).trigger("chosen:updated"),$(e.attributes).trigger("chosen:updated"),$(e.ranges).trigger("chosen:updated"),$(e.collections).trigger("chosen:updated")},1)})},this._rebuild_chosen=function(t,e){var a=$(".fancybox-iframe").get(0).contentWindow._DATA;if("undefined"==typeof a)return!1;var i=$(t);if(!i.length)return!1;if(i.each(function(){var t=this,e=[];$("option:selected",this).each(function(){e.push(parseInt($(this).val(),10))}),$(this).empty(),$.each(a,function(){var a=$("<option>");a.val(this.id),a.html(this.label),$.inArray(this.id,e)>-1&&a.prop("selected",!0),$(t).append(a)}),$(this).trigger("chosen:updated")}),e){var s=$("<div>").html($.parseHTML($.trim($("#"+e).html(),null,!0))),n=$("select",s).empty();$.each(a,function(){var t=$("<option>");t.val(this.id),t.html(this.label),$(n).append(t)}),$("#"+e).html($(s).html())}},this._init_submit=function(){var t=this;$("#product-form").on("submit",function(){return t._submit()})},this._submit=function(){return!0}};